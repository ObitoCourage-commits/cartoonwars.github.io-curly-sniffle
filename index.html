<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R6 Siege â€” Online Multiplayer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap');

  :root {
    --gold: #f7a800;
    --blue: #1a6bff;
    --red: #ff3a3a;
    --bg: #0a0b0d;
    --surface: #0f1117;
    --border: #1e2330;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: #e0e0e0;
    font-family: 'Rajdhani', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    user-select: none;
  }

  /* â”€â”€â”€ SCREENS â”€â”€â”€ */
  .screen { display: none; width: 100%; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
  .screen.active { display: flex; }

  /* â”€â”€â”€ MAIN MENU â”€â”€â”€ */
  #menu-screen { gap: 0; }

  .logo-wrap {
    text-align: center;
    margin-bottom: 48px;
  }

  .logo-title {
    font-size: 64px;
    font-weight: 700;
    letter-spacing: 10px;
    color: var(--gold);
    text-shadow: 0 0 60px rgba(247,168,0,0.35), 0 0 120px rgba(247,168,0,0.1);
    line-height: 1;
  }

  .logo-sub {
    font-size: 12px;
    letter-spacing: 6px;
    color: #444;
    font-family: 'Share Tech Mono', monospace;
    margin-top: 8px;
  }

  .menu-cards {
    display: flex;
    gap: 24px;
  }

  .menu-card {
    width: 240px;
    padding: 32px 24px;
    border: 1px solid var(--border);
    background: var(--surface);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    text-align: center;
  }

  .menu-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, transparent 60%, rgba(247,168,0,0.04));
    pointer-events: none;
  }

  .menu-card:hover {
    border-color: var(--gold);
    transform: translateY(-3px);
    box-shadow: 0 8px 32px rgba(247,168,0,0.1);
  }

  .card-icon {
    font-size: 40px;
    margin-bottom: 16px;
    display: block;
  }

  .card-title {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 4px;
    color: var(--gold);
    text-transform: uppercase;
  }

  .card-desc {
    font-size: 11px;
    letter-spacing: 2px;
    color: #555;
    font-family: 'Share Tech Mono', monospace;
    margin-top: 8px;
    line-height: 1.8;
  }

  .local-card .card-title { color: #aaa; }
  .local-card:hover { border-color: #aaa; box-shadow: 0 8px 32px rgba(255,255,255,0.05); }

  /* â”€â”€â”€ LOBBY SCREEN â”€â”€â”€ */
  #lobby-screen { gap: 0; }

  .lobby-container {
    width: 560px;
    border: 1px solid var(--border);
    background: var(--surface);
    padding: 40px;
  }

  .lobby-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .back-btn {
    background: none;
    border: 1px solid var(--border);
    color: #666;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    padding: 6px 12px;
    cursor: pointer;
    letter-spacing: 2px;
    transition: all 0.2s;
  }

  .back-btn:hover { border-color: var(--gold); color: var(--gold); }

  .lobby-title {
    font-size: 24px;
    font-weight: 700;
    letter-spacing: 5px;
    color: var(--gold);
    flex: 1;
  }

  /* Create party */
  #create-section { display: flex; flex-direction: column; gap: 20px; }

  .section-label {
    font-size: 11px;
    letter-spacing: 4px;
    color: #555;
    font-family: 'Share Tech Mono', monospace;
    text-transform: uppercase;
  }

  .room-code-display {
    background: #0a0b0d;
    border: 2px solid var(--gold);
    padding: 20px;
    text-align: center;
    position: relative;
  }

  .room-code-value {
    font-size: 42px;
    font-weight: 700;
    letter-spacing: 12px;
    color: #fff;
    font-family: 'Share Tech Mono', monospace;
  }

  .room-code-hint {
    font-size: 10px;
    letter-spacing: 3px;
    color: #444;
    font-family: 'Share Tech Mono', monospace;
    margin-top: 6px;
  }

  .copy-btn {
    position: absolute;
    top: 8px; right: 8px;
    background: none;
    border: 1px solid var(--border);
    color: #555;
    font-size: 10px;
    font-family: 'Share Tech Mono', monospace;
    padding: 4px 8px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.2s;
  }

  .copy-btn:hover { border-color: var(--gold); color: var(--gold); }

  .waiting-status {
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    letter-spacing: 2px;
    color: #555;
    padding: 14px;
    border: 1px solid var(--border);
  }

  .dot-pulse {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--gold);
    animation: pulse 1.2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.2; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.2); }
  }

  .dot-pulse.connected { background: #00ff88; animation: none; opacity: 1; }

  /* Player slots */
  .player-slots {
    display: flex;
    gap: 12px;
    margin: 8px 0;
  }

  .player-slot {
    flex: 1;
    padding: 14px;
    border: 1px dashed var(--border);
    text-align: center;
  }

  .player-slot.filled {
    border-style: solid;
    border-color: var(--gold);
    background: rgba(247,168,0,0.04);
  }

  .slot-label {
    font-size: 10px;
    letter-spacing: 3px;
    color: #444;
    font-family: 'Share Tech Mono', monospace;
  }

  .slot-name {
    font-size: 16px;
    font-weight: 700;
    margin-top: 4px;
    color: #888;
  }

  .slot-name.active { color: var(--gold); }

  .slot-role {
    font-size: 10px;
    letter-spacing: 2px;
    font-family: 'Share Tech Mono', monospace;
    margin-top: 2px;
  }

  /* Join section */
  #join-section { display: flex; flex-direction: column; gap: 20px; }

  .code-input-wrap {
    display: flex;
    gap: 0;
  }

  .code-input {
    flex: 1;
    background: #0a0b0d;
    border: 2px solid var(--border);
    border-right: none;
    color: #fff;
    font-family: 'Share Tech Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    letter-spacing: 8px;
    padding: 16px 20px;
    text-transform: uppercase;
    text-align: center;
    outline: none;
    transition: border-color 0.2s;
  }

  .code-input:focus { border-color: var(--gold); }

  .join-btn {
    padding: 16px 28px;
    background: var(--gold);
    border: none;
    color: #000;
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }

  .join-btn:hover { background: #ffc200; }
  .join-btn:disabled { background: #333; color: #666; cursor: not-allowed; }

  .status-msg {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    padding: 10px 14px;
    border-left: 2px solid transparent;
  }

  .status-msg.info { color: #555; border-color: #333; }
  .status-msg.error { color: #ff4444; border-color: #ff4444; background: rgba(255,68,68,0.05); }
  .status-msg.success { color: #00ff88; border-color: #00ff88; background: rgba(0,255,136,0.05); }
  .status-msg.warn { color: var(--gold); border-color: var(--gold); background: rgba(247,168,0,0.05); }

  /* Deploy / Start button */
  .deploy-btn {
    width: 100%;
    padding: 16px;
    background: transparent;
    border: 2px solid var(--gold);
    color: var(--gold);
    font-family: 'Rajdhani', sans-serif;
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 6px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
  }

  .deploy-btn:hover:not(:disabled) { background: var(--gold); color: #000; }
  .deploy-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  /* â”€â”€â”€ GAME SCREEN â”€â”€â”€ */
  #game-screen { gap: 0; justify-content: center; }

  #hud {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 800px;
    padding: 8px 12px;
    background: rgba(10,11,13,0.95);
    border: 1px solid var(--border);
    border-bottom: 2px solid var(--gold);
  }

  .player-hud { display: flex; flex-direction: column; gap: 4px; min-width: 180px; }
  .player-hud.p2 { align-items: flex-end; }

  .player-name {
    font-size: 11px; letter-spacing: 3px; text-transform: uppercase;
    color: #888; font-family: 'Share Tech Mono', monospace;
  }

  .health-bar-wrap {
    width: 170px; height: 8px;
    background: #1a1a1a; border: 1px solid #333;
  }

  .health-bar { height: 100%; transition: width 0.1s; }
  #p1-health-bar { background: linear-gradient(90deg, var(--blue), #44aaff); }
  #p2-health-bar { background: linear-gradient(90deg, var(--red), #ff7a1a); }

  .ammo-display { font-family: 'Share Tech Mono', monospace; font-size: 13px; letter-spacing: 2px; }

  #center-hud { text-align: center; flex: 1; }
  #round-info { font-size: 11px; color: var(--gold); letter-spacing: 4px; font-family: 'Share Tech Mono', monospace; }
  #score-display { font-size: 26px; font-weight: 700; letter-spacing: 8px; color: #fff; }
  #score-display .sep { color: var(--gold); }

  #ping-display {
    position: absolute;
    top: 6px; right: 10px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: #333;
    letter-spacing: 1px;
  }

  canvas { display: block; border: 1px solid var(--border); border-top: none; cursor: none; }

  /* â”€â”€â”€ GAME OVERLAY â”€â”€â”€ */
  #game-overlay {
    position: fixed; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(0,0,0,0.88);
    z-index: 100; gap: 20px;
  }

  #game-overlay.hidden { display: none; }

  .overlay-title {
    font-size: 52px; font-weight: 700; letter-spacing: 8px;
    text-transform: uppercase; color: var(--gold);
    text-shadow: 0 0 40px rgba(247,168,0,0.4);
  }

  .overlay-sub { font-size: 14px; letter-spacing: 4px; color: #888; font-family: 'Share Tech Mono', monospace; }

  .btn {
    margin-top: 10px; padding: 12px 40px;
    background: transparent; border: 2px solid var(--gold);
    color: var(--gold); font-family: 'Rajdhani', sans-serif;
    font-size: 16px; font-weight: 700; letter-spacing: 4px;
    text-transform: uppercase; cursor: pointer; transition: all 0.2s;
  }

  .btn:hover { background: var(--gold); color: #000; }

  #winner-text { font-size: 22px; letter-spacing: 5px; color: #fff; font-family: 'Share Tech Mono', monospace; }

  /* Divider */
  .divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 8px 0;
  }

  /* Name input */
  .name-input {
    background: #0a0b0d;
    border: 1px solid var(--border);
    color: #fff;
    font-family: 'Share Tech Mono', monospace;
    font-size: 14px;
    letter-spacing: 3px;
    padding: 10px 14px;
    outline: none;
    width: 100%;
    transition: border-color 0.2s;
    text-transform: uppercase;
  }

  .name-input:focus { border-color: var(--gold); }

  .connection-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    color: #444;
    padding: 4px 8px;
    border: 1px solid var(--border);
  }

  .connection-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: #444; }
  .connection-badge.online .dot { background: #00ff88; }
  .connection-badge.online { color: #00ff88; border-color: #00ff8844; }

</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MENU SCREEN -->
<div id="menu-screen" class="screen active">
  <div class="logo-wrap">
    <div class="logo-title">R6 SIEGE</div>
    <div class="logo-sub">ONLINE Â· TACTICAL SHOOTER</div>
  </div>
  <div class="menu-cards">
    <div class="menu-card" onclick="showLobby('create')">
      <span class="card-icon">ğŸ </span>
      <div class="card-title">Create Party</div>
      <div class="card-desc">Generate a room code<br>and invite a friend</div>
    </div>
    <div class="menu-card" onclick="showLobby('join')">
      <span class="card-icon">ğŸ”—</span>
      <div class="card-title">Join Party</div>
      <div class="card-desc">Enter a room code<br>to join a match</div>
    </div>
    <div class="menu-card local-card" onclick="playLocal()">
      <span class="card-icon">âŒ¨ï¸</span>
      <div class="card-title" style="color:#aaa">Local Play</div>
      <div class="card-desc">Two players<br>one keyboard</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOBBY SCREEN -->
<div id="lobby-screen" class="screen">
  <div class="lobby-container">
    <div class="lobby-header">
      <button class="back-btn" onclick="goBack()">â—€ BACK</button>
      <div class="lobby-title" id="lobby-title">CREATE PARTY</div>
      <div class="connection-badge" id="conn-badge"><span class="dot"></span>CONNECTING</div>
    </div>

    <!-- Create section -->
    <div id="create-section" style="display:none; flex-direction:column; gap:18px;">
      <div>
        <div class="section-label">Your Name</div>
        <input class="name-input" id="host-name" maxlength="12" placeholder="OPERATOR" value="HOST" />
      </div>
      <div>
        <div class="section-label">Room Code â€” Share This</div>
        <div class="room-code-display">
          <div class="room-code-value" id="room-code">â€”â€”</div>
          <div class="room-code-hint">SHARE THIS CODE WITH YOUR OPPONENT</div>
          <button class="copy-btn" onclick="copyCode()">COPY</button>
        </div>
      </div>
      <div class="player-slots">
        <div class="player-slot filled" id="slot1">
          <div class="slot-label">PLAYER 1</div>
          <div class="slot-name active" id="slot1-name">YOU</div>
          <div class="slot-role" style="color:var(--blue)">ATTACKER</div>
        </div>
        <div class="player-slot" id="slot2">
          <div class="slot-label">PLAYER 2</div>
          <div class="slot-name" id="slot2-name">WAITING...</div>
          <div class="slot-role" style="color:#444">DEFENDER</div>
        </div>
      </div>
      <div class="waiting-status" id="create-status">
        <div class="dot-pulse" id="create-dot"></div>
        <span id="create-status-text">Waiting for opponent to connect...</span>
      </div>
      <button class="deploy-btn" id="host-deploy-btn" onclick="hostStartGame()" disabled>DEPLOY â€” WAITING FOR PLAYER 2</button>
    </div>

    <!-- Join section -->
    <div id="join-section" style="display:none; flex-direction:column; gap:18px;">
      <div>
        <div class="section-label">Your Name</div>
        <input class="name-input" id="guest-name" maxlength="12" placeholder="OPERATOR" value="GUEST" />
      </div>
      <div>
        <div class="section-label">Enter Room Code</div>
        <div class="code-input-wrap">
          <input class="code-input" id="room-code-input" maxlength="6" placeholder="ABCDEF" />
          <button class="join-btn" id="join-now-btn" onclick="joinRoom()">JOIN</button>
        </div>
      </div>
      <div class="player-slots">
        <div class="player-slot" id="jslot1">
          <div class="slot-label">PLAYER 1</div>
          <div class="slot-name" id="jslot1-name">HOST</div>
          <div class="slot-role" style="color:var(--blue)">ATTACKER</div>
        </div>
        <div class="player-slot filled" id="jslot2">
          <div class="slot-label">PLAYER 2</div>
          <div class="slot-name active" id="jslot2-name">YOU</div>
          <div class="slot-role" style="color:var(--red)">DEFENDER</div>
        </div>
      </div>
      <div class="status-msg info" id="join-status">Enter the 6-character code from your host and press JOIN.</div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME SCREEN -->
<div id="game-screen" class="screen">
  <div id="hud" style="position:relative;">
    <div class="player-hud p1">
      <span class="player-name" id="p1-name-hud">â–¶ ATTACKER</span>
      <div class="health-bar-wrap">
        <div class="health-bar" id="p1-health-bar" style="width:100%"></div>
      </div>
      <span class="ammo-display" id="p1-ammo" style="color:var(--blue)">AMM: 30/30</span>
    </div>
    <div id="center-hud">
      <div id="round-info">ROUND 1</div>
      <div id="score-display"><span id="s1">0</span><span class="sep"> Â· </span><span id="s2">0</span></div>
    </div>
    <div class="player-hud p2">
      <span class="player-name" id="p2-name-hud">DEFENDER â—€</span>
      <div class="health-bar-wrap">
        <div class="health-bar" id="p2-health-bar" style="width:100%"></div>
      </div>
      <span class="ammo-display" id="p2-ammo" style="color:var(--red)">AMM: 30/30</span>
    </div>
    <div id="ping-display">PING: â€”</div>
  </div>
  <canvas id="game" width="800" height="550"></canvas>
  <div id="game-overlay">
    <div class="overlay-title">R6 SIEGE</div>
    <div class="overlay-sub">MATCH STARTING...</div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const W = 800, H = 550, TILE = 40, SPEED = 2.5;

const MAP = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,2,0,0,1,0,0,0,0,0,0,1,0,0,2,0,0,1],
  [1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,1,1,0,1,1,1,0,0,0,0,0,0,1,1,1,0,1,1,1],
  [1,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,1],
  [1,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,1,1,0,1,1,1,0,0,0,0,0,0,1,1,1,0,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,2,0,0,1,0,0,0,0,0,0,1,0,0,2,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
];

// Networking
let peer, conn;
let isHost = false;
let myPlayerIndex = -1; // 0 = attacker, 1 = defender
let opponentName = 'OPPONENT';
let myName = 'PLAYER';
let roomCode = '';
let pingTimer = 0, lastPingSent = 0, currentPing = 0;

// Stores the latest input received from the guest (used by host every frame)
let remoteInput = { up:0, down:0, left:0, right:0, shoot:0, reload:0 };

// Game state (authoritative on HOST, mirrored on GUEST)
let players, bullets, roundState, scores, round, gameActive, gameLoopRunning;
const keys = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showLobby(mode) {
  showScreen('lobby-screen');
  document.getElementById('lobby-title').textContent = mode === 'create' ? 'CREATE PARTY' : 'JOIN PARTY';
  document.getElementById('create-section').style.display = mode === 'create' ? 'flex' : 'none';
  document.getElementById('join-section').style.display = mode === 'join' ? 'flex' : 'none';

  if (mode === 'create') {
    setupHostPeer();
  } else {
    setupGuestPeer();
  }
}

function goBack() {
  if (peer) { peer.destroy(); peer = null; conn = null; }
  showScreen('menu-screen');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCAL PLAY MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playLocal() {
  myPlayerIndex = -2; // local mode sentinel
  isHost = true;
  showScreen('game-screen');
  document.getElementById('p1-name-hud').textContent = 'â–¶ ATTACKER Â· WASD';
  document.getElementById('p2-name-hud').textContent = 'DEFENDER Â· ARROWS â—€';
  initGame();
  showGameOverlay(`
    <div class="overlay-title">LOCAL PLAY</div>
    <div class="overlay-sub">2 PLAYERS Â· 1 KEYBOARD</div>
    <button class="btn" onclick="dismissOverlayAndStart()">DEPLOY</button>
  `);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PEER.JS NETWORKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genCode() {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

function setupHostPeer() {
  roomCode = genCode();
  const badge = document.getElementById('conn-badge');
  badge.innerHTML = '<span class="dot"></span>CONNECTING';

  peer = new Peer('r6-' + roomCode, {
    host: '0.peerjs.com', port: 443, secure: true,
    config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
  });

  peer.on('open', id => {
    badge.innerHTML = '<span class="dot" style="background:#00ff88"></span>READY';
    badge.classList.add('online');
    document.getElementById('room-code').textContent = roomCode;
    isHost = true;
    myPlayerIndex = 0;
    myName = document.getElementById('host-name').value.trim().toUpperCase() || 'HOST';
    document.getElementById('slot1-name').textContent = myName;
  });

  peer.on('connection', c => {
    conn = c;
    setupConnHandlers();
    document.getElementById('create-dot').classList.add('connected');
    document.getElementById('create-status-text').textContent = 'Opponent connected! Ready to deploy.';
    document.getElementById('slot2').classList.add('filled');
    document.getElementById('host-deploy-btn').disabled = false;
    document.getElementById('host-deploy-btn').textContent = 'â–¶ DEPLOY';
  });

  peer.on('error', err => {
    document.getElementById('room-code').textContent = 'ERROR';
    badge.innerHTML = '<span class="dot" style="background:red"></span>ERROR';
    console.error('Peer error:', err);
  });
}

function setupGuestPeer() {
  const badge = document.getElementById('conn-badge');
  badge.innerHTML = '<span class="dot"></span>READY';
  badge.classList.add('online');
  // Guest peer ID is random
  peer = new Peer(undefined, {
    host: '0.peerjs.com', port: 443, secure: true,
    config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
  });

  peer.on('open', id => {
    // Ready to join
  });

  peer.on('error', err => {
    setJoinStatus('Connection error: ' + err.type, 'error');
  });
}

function joinRoom() {
  const codeRaw = document.getElementById('room-code-input').value.trim().toUpperCase();
  if (codeRaw.length < 4) { setJoinStatus('Enter a valid room code.', 'error'); return; }

  myName = document.getElementById('guest-name').value.trim().toUpperCase() || 'GUEST';
  document.getElementById('jslot2-name').textContent = myName;
  isHost = false;
  myPlayerIndex = 1;
  roomCode = codeRaw;

  setJoinStatus('Connecting to host...', 'warn');
  document.getElementById('join-now-btn').disabled = true;

  const targetId = 'r6-' + codeRaw;
  conn = peer.connect(targetId, { reliable: true });

  conn.on('open', () => {
    setJoinStatus('Connected! Waiting for host to start...', 'success');
    document.getElementById('jslot1-name').textContent = 'HOST';
    document.getElementById('jslot1').classList.add('filled');
    setupConnHandlers();
    send({ type: 'hello', name: myName });
  });

  conn.on('error', err => {
    setJoinStatus('Could not connect. Check the code and try again.', 'error');
    document.getElementById('join-now-btn').disabled = false;
  });
}

function setupConnHandlers() {
  conn.on('data', handleMessage);
  conn.on('close', () => {
    if (gameActive) {
      showGameOverlay(`<div class="overlay-title">DISCONNECTED</div>
        <div class="overlay-sub">OPPONENT LEFT THE MATCH</div>
        <button class="btn" onclick="location.reload()">MAIN MENU</button>`);
      gameActive = false;
    }
  });
}

function send(data) {
  if (conn && conn.open) {
    try { conn.send(data); } catch(e){}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGE HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleMessage(msg) {
  switch(msg.type) {
    case 'hello':
      opponentName = msg.name;
      if (isHost) {
        document.getElementById('slot2-name').textContent = opponentName;
        send({ type: 'welcome', name: myName });
      }
      break;

    case 'welcome':
      opponentName = msg.name;
      document.getElementById('jslot1-name').textContent = opponentName;
      break;

    case 'start':
      // Host tells guest to start
      startOnlineGame();
      break;

    case 'input':
      // Guest sent their input â€” store it, host applies it every frame
      if (isHost) {
        remoteInput = { up: msg.up, down: msg.down, left: msg.left, right: msg.right, shoot: msg.shoot, reload: msg.reload };
      }
      break;

    case 'state':
      // Host sends game state to guest
      if (!isHost && players) {
        applyHostState(msg);
      }
      break;

    case 'ping':
      send({ type: 'pong', t: msg.t });
      break;

    case 'pong':
      currentPing = Date.now() - msg.t;
      document.getElementById('ping-display').textContent = `PING: ${currentPing}ms`;
      break;

    case 'round_end':
      if (!isHost) {
        scores[msg.winner]++;
        document.getElementById('s1').textContent = scores[0];
        document.getElementById('s2').textContent = scores[1];
        if (msg.matchOver) {
          showWinner(msg.winner);
        } else {
          round = msg.round;
          document.getElementById('round-info').textContent = `ROUND ${round}`;
        }
      }
      break;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOST START / GAME INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hostStartGame() {
  myName = document.getElementById('host-name').value.trim().toUpperCase() || 'HOST';
  send({ type: 'start', hostName: myName, guestName: opponentName });
  startOnlineGame();
}

function startOnlineGame() {
  showScreen('game-screen');
  const p1n = isHost ? myName : opponentName;
  const p2n = isHost ? opponentName : myName;
  document.getElementById('p1-name-hud').textContent = `â–¶ ${p1n}`;
  document.getElementById('p2-name-hud').textContent = `${p2n} â—€`;

  // Guest uses WASD on their own machine
  const myKeys = myPlayerIndex === 1 ? 'WASD Â· F=Shoot Â· R=Reload' : 'WASD Â· F=Shoot Â· R=Reload';
  const roleLabel = myPlayerIndex === 0 ? 'ATTACKER' : myPlayerIndex === 1 ? 'DEFENDER' : '';

  initGame();
  showGameOverlay(`<div class="overlay-title">MATCH FOUND</div>
    <div class="overlay-sub">YOU ARE: ${roleLabel} Â· WASD TO MOVE Â· F=SHOOT Â· R=RELOAD</div>`);
  setTimeout(() => {
    document.getElementById('game-overlay').classList.add('hidden');
    gameActive = true;
    if (!gameLoopRunning) { gameLoopRunning = true; requestAnimationFrame(loop); }
  }, 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

function makePlayer(id) {
  const isP1 = id === 0;
  // Spawn positions: center of safe open floor tiles
  // Blue (P1): tile col=1, row=1 â†’ pixel (60, 60)
  // Red  (P2): tile col=17, row=12 â†’ pixel (700, 500) â€” confirmed open floor
  return {
    id, alive: true,
    x: isP1 ? 60 : 700,
    y: isP1 ? 60 : 500,
    angle: isP1 ? 0 : Math.PI,
    hp: 100, maxHp: 100,
    ammo: 30, maxAmmo: 30,
    reloading: false, reloadTimer: 0, shootCooldown: 0,
    color: isP1 ? '#1a6bff' : '#ff3a3a',
    darkColor: isP1 ? '#0040aa' : '#aa0000',
    // Local play: P1=WASD, P2=Arrows. Online: each player uses WASD on their own machine.
    keys: id === 0
      ? { up:'KeyW', down:'KeyS', left:'KeyA', right:'KeyD', shoot:'KeyF', reload:'KeyR' }
      : { up:'ArrowUp', down:'ArrowDown', left:'ArrowLeft', right:'ArrowRight', shoot:'NumpadDivide', reload:'NumpadDecimal' }
  };
}

function initGame() {
  scores = [0, 0];
  round = 1;
  bullets = [];
  roundState = 'playing';
  initRound();
  // Guest is player index 1 but uses WASD on their own keyboard
  if (myPlayerIndex === 1) {
    players[1].keys = { up:'KeyW', down:'KeyS', left:'KeyA', right:'KeyD', shoot:'KeyF', reload:'KeyR' };
  }
  document.getElementById('s1').textContent = 0;
  document.getElementById('s2').textContent = 0;
  document.getElementById('round-info').textContent = 'ROUND 1';
}

function initRound() {
  players = [makePlayer(0), makePlayer(1)];
  bullets = [];
  roundState = 'playing';
  // Guest uses WASD on their own machine
  if (myPlayerIndex === 1) {
    players[1].keys = { up:'KeyW', down:'KeyS', left:'KeyA', right:'KeyD', shoot:'KeyF', reload:'KeyR' };
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('keydown', e => {
  keys[e.code] = true;
  e.preventDefault();
});
window.addEventListener('keyup', e => { keys[e.code] = false; e.preventDefault(); });

function getMyKeys() {
  if (myPlayerIndex === -2) return null; // local: both handled in update
  const p = players[myPlayerIndex];
  return {
    up: keys[p.keys.up] ? 1 : 0,
    down: keys[p.keys.down] ? 1 : 0,
    left: keys[p.keys.left] ? 1 : 0,
    right: keys[p.keys.right] ? 1 : 0,
    shoot: keys[p.keys.shoot] ? 1 : 0,
    reload: keys[p.keys.reload] ? 1 : 0,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isSolid(tx, ty) {
  if (ty < 0 || ty >= MAP.length || tx < 0 || tx >= MAP[0].length) return true;
  return MAP[ty][tx] === 1;
}

function isBlockingBullet(tx, ty) {
  if (ty < 0 || ty >= MAP.length || tx < 0 || tx >= MAP[0].length) return true;
  return MAP[ty][tx] >= 1;
}

function circleRect(cx, cy, r, rx, ry) {
  let nx = Math.max(rx, Math.min(cx, rx + TILE));
  let ny = Math.max(ry, Math.min(cy, ry + TILE));
  return (cx-nx)**2 + (cy-ny)**2 < r*r;
}

function wallCollide(px, py) {
  const r = 12;
  const checks = [
    [Math.floor((px-r)/TILE), Math.floor((py-r)/TILE)],
    [Math.floor((px+r)/TILE), Math.floor((py-r)/TILE)],
    [Math.floor((px-r)/TILE), Math.floor((py+r)/TILE)],
    [Math.floor((px+r)/TILE), Math.floor((py+r)/TILE)],
  ];
  for (let [tx,ty] of checks) if (isSolid(tx,ty) && circleRect(px,py,r,tx*TILE,ty*TILE)) return true;
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOVE + SHOOT (takes explicit input state)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stepPlayer(p, inp) {
  if (!p.alive) return;
  let other = players[1 - p.id];
  if (other.alive) p.angle = Math.atan2(other.y - p.y, other.x - p.x);

  let dx = (inp.right - inp.left), dy = (inp.down - inp.up);
  if (dx && dy) { dx *= 0.707; dy *= 0.707; }
  let nx = Math.max(14, Math.min(W-14, p.x + dx * SPEED));
  let ny = Math.max(14, Math.min(H-14, p.y + dy * SPEED));
  if (!wallCollide(nx, p.y)) p.x = nx;
  if (!wallCollide(p.x, ny)) p.y = ny;

  if (p.reloading) { if (--p.reloadTimer <= 0) { p.reloading = false; p.ammo = p.maxAmmo; } }
  if (inp.reload && !p.reloading && p.ammo < p.maxAmmo) { p.reloading = true; p.reloadTimer = 120; }
  if (p.ammo === 0 && !p.reloading) { p.reloading = true; p.reloadTimer = 120; }
  if (p.shootCooldown > 0) p.shootCooldown--;
  if (inp.shoot && p.shootCooldown === 0 && !p.reloading && p.ammo > 0) {
    p.ammo--;
    p.shootCooldown = 10;
    const sp = (Math.random() - 0.5) * 0.08;
    bullets.push({ x: p.x + Math.cos(p.angle)*16, y: p.y + Math.sin(p.angle)*16, vx: Math.cos(p.angle+sp)*10, vy: Math.sin(p.angle+sp)*10, owner: p.id, life: 80, color: p.color });
  }
}

function applyRemoteInput(p, inp) {
  stepPlayer(p, inp);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATE (host is authoritative)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let frameCount = 0;

function update() {
  if (roundState !== 'playing') return;

  if (isHost || myPlayerIndex === -2) {
    // LOCAL: drive both players from keyboard
    if (myPlayerIndex === -2) {
      for (let p of players) {
        const inp = {
          up: keys[p.keys.up]?1:0, down: keys[p.keys.down]?1:0,
          left: keys[p.keys.left]?1:0, right: keys[p.keys.right]?1:0,
          shoot: keys[p.keys.shoot]?1:0, reload: keys[p.keys.reload]?1:0
        };
        stepPlayer(p, inp);
      }
    } else {
      // ONLINE HOST: step own player (P1) from local keys
      const myInp = {
        up: keys[players[0].keys.up]?1:0, down: keys[players[0].keys.down]?1:0,
        left: keys[players[0].keys.left]?1:0, right: keys[players[0].keys.right]?1:0,
        shoot: keys[players[0].keys.shoot]?1:0, reload: keys[players[0].keys.reload]?1:0
      };
      stepPlayer(players[0], myInp);

      // Step guest's player (P2) from the latest remoteInput received
      stepPlayer(players[1], remoteInput);
    }

    // Bullets (host is authoritative)
    for (let i = bullets.length - 1; i >= 0; i--) {
      let b = bullets[i];
      b.x += b.vx; b.y += b.vy; b.life--;
      let tx = Math.floor(b.x/TILE), ty = Math.floor(b.y/TILE);
      if (isBlockingBullet(tx,ty) || b.life<=0 || b.x<0||b.x>W||b.y<0||b.y>H) { bullets.splice(i,1); continue; }
      for (let p of players) {
        if (p.id !== b.owner && p.alive) {
          if ((b.x-p.x)**2+(b.y-p.y)**2 < 14*14) {
            p.hp = Math.max(0, p.hp - (15 + Math.random()*10|0));
            bullets.splice(i,1);
            if (p.hp <= 0) { p.alive = false; endRound(b.owner); }
            break;
          }
        }
      }
    }

    // Broadcast authoritative state to guest every 2 frames
    if (myPlayerIndex !== -2 && frameCount % 2 === 0) {
      send({ type: 'state',
        p0: { x: players[0].x, y: players[0].y, hp: players[0].hp, ammo: players[0].ammo, reloading: players[0].reloading, reloadTimer: players[0].reloadTimer, alive: players[0].alive, angle: players[0].angle },
        p1: { x: players[1].x, y: players[1].y, hp: players[1].hp, ammo: players[1].ammo, reloading: players[1].reloading, reloadTimer: players[1].reloadTimer, alive: players[1].alive, angle: players[1].angle },
        bullets: bullets.map(b=>({x:b.x,y:b.y,vx:b.vx,vy:b.vy,owner:b.owner,color:b.color}))
      });
    }

    // Ping
    pingTimer++;
    if (pingTimer > 60 && myPlayerIndex !== -2) {
      pingTimer = 0;
      send({ type: 'ping', t: Date.now() });
    }
  } else {
    // GUEST: send own inputs to host every single frame for responsiveness
    const p = players[myPlayerIndex];
    send({ type: 'input',
      up: keys[p.keys.up]?1:0, down: keys[p.keys.down]?1:0,
      left: keys[p.keys.left]?1:0, right: keys[p.keys.right]?1:0,
      shoot: keys[p.keys.shoot]?1:0, reload: keys[p.keys.reload]?1:0
    });

    // Guest-side: smoothly move bullets visually (state will be corrected by host)
    for (let b of bullets) { b.x += b.vx; b.y += b.vy; }
  }

  frameCount++;
  updateHUD();
}

function applyHostState(msg) {
  if (!players) return;
  for (let key of ['x','y','hp','ammo','reloading','reloadTimer','alive','angle']) {
    players[0][key] = msg.p0[key];
    players[1][key] = msg.p1[key];
  }
  bullets = msg.bullets.map(b => ({ ...b, life: 30 }));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUND / MATCH MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function endRound(winner) {
  if (roundState !== 'playing') return;
  roundState = 'over';
  scores[winner]++;
  document.getElementById('s1').textContent = scores[0];
  document.getElementById('s2').textContent = scores[1];

  const matchOver = scores[0] >= 3 || scores[1] >= 3;
  if (myPlayerIndex !== -2) {
    send({ type: 'round_end', winner, round: round + 1, matchOver });
  }

  setTimeout(() => {
    if (matchOver) {
      showWinner(winner);
    } else {
      round++;
      document.getElementById('round-info').textContent = `ROUND ${round}`;
      initRound();
    }
  }, 1800);
}

function showWinner(winner) {
  const isMe = winner === myPlayerIndex || myPlayerIndex === -2;
  const col = winner === 0 ? '#1a6bff' : '#ff3a3a';
  const role = winner === 0 ? 'ATTACKER' : 'DEFENDER';
  showGameOverlay(`
    <div class="overlay-title" style="color:${col}">${role}</div>
    <div id="winner-text">WINS THE MATCH</div>
    <div class="overlay-sub">SCORE: ${scores[0]} â€” ${scores[1]}</div>
    <button class="btn" onclick="location.reload()">MAIN MENU</button>
  `);
  gameActive = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD() {
  if (!players) return;
  const p1 = players[0], p2 = players[1];
  document.getElementById('p1-health-bar').style.width = (p1.hp/p1.maxHp*100) + '%';
  document.getElementById('p2-health-bar').style.width = (p2.hp/p2.maxHp*100) + '%';
  document.getElementById('p1-ammo').textContent = p1.reloading ? 'RELOADING...' : `AMM: ${p1.ammo}/${p1.maxAmmo}`;
  document.getElementById('p2-ammo').textContent = p2.reloading ? 'RELOADING...' : `AMM: ${p2.ammo}/${p2.maxAmmo}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawMap() {
  for (let row = 0; row < MAP.length; row++) {
    for (let col = 0; col < MAP[row].length; col++) {
      let cell = MAP[row][col], x = col*TILE, y = row*TILE;
      if (cell === 1) {
        ctx.fillStyle = '#0d0f14'; ctx.fillRect(x,y,TILE,TILE);
        ctx.fillStyle = '#181c24'; ctx.fillRect(x+1,y+1,TILE-2,TILE-2);
        ctx.strokeStyle = '#f7a80022'; ctx.lineWidth = 0.5; ctx.strokeRect(x,y,TILE,TILE);
      } else if (cell === 2) {
        ctx.fillStyle = '#1a1e2a'; ctx.fillRect(x,y,TILE,TILE);
        ctx.fillStyle = '#2a3040'; ctx.fillRect(x+4,y+4,TILE-8,TILE-8);
        ctx.strokeStyle = '#f7a80044'; ctx.lineWidth = 1; ctx.strokeRect(x+4,y+4,TILE-8,TILE-8);
      } else {
        ctx.fillStyle = (row+col)%2===0 ? '#111318' : '#12141a'; ctx.fillRect(x,y,TILE,TILE);
      }
    }
  }
}

function drawPlayer(p) {
  if (!p.alive) return;
  ctx.save(); ctx.translate(p.x, p.y);
  ctx.shadowColor = p.color; ctx.shadowBlur = 14;
  ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); ctx.fillStyle = p.darkColor; ctx.fill();
  ctx.strokeStyle = p.color; ctx.lineWidth = 2; ctx.stroke();
  ctx.shadowBlur = 0;

  // "YOU" indicator ring
  if (p.id === myPlayerIndex) {
    ctx.beginPath(); ctx.arc(0,0,16,0,Math.PI*2);
    ctx.strokeStyle = p.color + '55'; ctx.lineWidth = 1; ctx.stroke();
  }

  ctx.rotate(p.angle);
  ctx.fillStyle = p.color; ctx.fillRect(10,-2,14,4);
  ctx.beginPath(); ctx.arc(0,0,3,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
  ctx.restore();

  if (p.reloading) {
    const prog = 1 - (p.reloadTimer/120);
    ctx.beginPath(); ctx.arc(p.x,p.y,17,-Math.PI/2,-Math.PI/2+Math.PI*2*prog);
    ctx.strokeStyle = '#f7a800'; ctx.lineWidth=2; ctx.stroke();
  }
}

function drawBullets() {
  for (let b of bullets) {
    ctx.save();
    ctx.shadowColor = b.color; ctx.shadowBlur = 8;
    ctx.beginPath(); ctx.arc(b.x,b.y,3,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
    ctx.beginPath(); ctx.arc(b.x,b.y,2,0,Math.PI*2); ctx.fillStyle=b.color; ctx.fill();
    ctx.restore();
  }
}

function drawRoundOver() {
  if (roundState === 'over') {
    ctx.fillStyle = 'rgba(0,0,0,0.45)'; ctx.fillRect(0,0,W,H);
    let dead = players.find(p => !p.alive);
    if (dead) {
      ctx.fillStyle = dead.color + '99'; ctx.font = 'bold 18px Rajdhani';
      ctx.textAlign = 'center';
      const name = dead.id === 0 ? 'ATTACKER' : 'DEFENDER';
      ctx.fillText(`${name} ELIMINATED`, W/2, H/2-10);
      ctx.fillStyle = '#f7a800'; ctx.font = '13px Share Tech Mono';
      ctx.fillText(`ROUND TO ${dead.id===0?'DEFENDER':'ATTACKER'}`, W/2, H/2+16);
    }
  }
}

function loop(ts) {
  if (!gameLoopRunning) return;
  if (gameActive) update();
  ctx.clearRect(0,0,W,H);
  if (players) {
    drawMap();
    drawBullets();
    players.forEach(drawPlayer);
    drawRoundOver();
  }
  requestAnimationFrame(loop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERLAY HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showGameOverlay(html) {
  const el = document.getElementById('game-overlay');
  el.innerHTML = html;
  el.classList.remove('hidden');
}

function dismissOverlayAndStart() {
  document.getElementById('game-overlay').classList.add('hidden');
  gameActive = true;
  if (!gameLoopRunning) { gameLoopRunning = true; requestAnimationFrame(loop); }
}

function setJoinStatus(msg, type='info') {
  const el = document.getElementById('join-status');
  el.textContent = msg;
  el.className = `status-msg ${type}`;
}

function copyCode() {
  const code = document.getElementById('room-code').textContent;
  if (code !== 'â€”â€”') {
    navigator.clipboard.writeText(code).then(() => {
      const btn = document.querySelector('.copy-btn');
      btn.textContent = 'COPIED!';
      setTimeout(() => btn.textContent = 'COPY', 1500);
    });
  }
}
</script>
</body>
</html>
